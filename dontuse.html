<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hockey Board Responsive</title>
    <script src="https://unpkg.com/konva@9/konva.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #222;
            touch-action: none;
            font-family: sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        #container {
            width: 100vw;
            height: 100vh;
            background-color: #222;
        }
        #toolbar {
            position: absolute;
            bottom: 10px; /* å°‘ã—è©°ã‚ã‚‹ */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px; /* é–“éš”ã‚‚å°‘ã—è©°ã‚ã‚‹ */
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex-wrap: wrap; 
            justify-content: center;
            width: auto; 
            min-width: 280px;
            z-index: 100;
        }
        button {
            padding: 10px 14px;
            font-size: 13px; /* ãƒœã‚¿ãƒ³æ–‡å­—ã‚‚å°‘ã—å°ã•ã */
            font-weight: bold;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
            color: #333;
            cursor: pointer;
            flex-shrink: 0;
        }
        button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 2px 4px rgba(0,123,255,0.3);
        }
        button#clear-btn {
            color: #d9534f;
            border-color: #d9534f;
        }
        /* ã‚¹ãƒãƒ›ç¸¦å‘ãè­¦å‘Šç”¨ */
        #portrait-warning {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 18px;
            padding: 20px;
        }
        @media (orientation: portrait) {
            #portrait-warning { display: flex; }
        }
    </style>
</head>
<body>

    <div id="portrait-warning">
        <p>âš ï¸ ç”»é¢ã‚’æ¨ªå‘ãã«ã—ã¦ãã ã•ã„ âš ï¸</p>
        <p>Please rotate your device</p>
    </div>

    <div id="container"></div>

    <div id="toolbar">
        <button id="mode-drag" class="active">âœ‹ ç§»å‹•</button>
        <button id="mode-pen">ğŸ–Šï¸ ãƒšãƒ³</button>
        <button id="mode-eraser">ğŸ§½ æ¶ˆã—ã‚´ãƒ </button>
        <button id="clear-btn">å…¨æ¶ˆå»</button>
    </div>

    <script>
        // --- 1. ã‚µã‚¤ã‚ºè¨ˆç®—ã®åŸºæº–ã‚’ä½œã‚‹ ---
        // ç”»é¢å¹…ãŒå¤‰ã‚ã£ã¦ã‚‚æ¯”ç‡ã‚’ä¿ã¤ãŸã‚ã®ã€Œãƒ¦ãƒ‹ãƒƒãƒˆã€ã‚’è¨ˆç®—
        const width = window.innerWidth;
        const height = window.innerHeight;

        // åŸºæº–ã‚µã‚¤ã‚ºï¼ˆç”»é¢ã®çŸ­ã„æ–¹ã‚’åŸºæº–ã«ã™ã‚‹ï¼‰
        const baseSize = Math.min(width, height);
        
        // å„ç¨®ã‚µã‚¤ã‚ºã®è‡ªå‹•è¨ˆç®—
        const SIZES = {
            lineThick: baseSize * 0.006,    // ç·šã®å¤ªã•
            lineThin: baseSize * 0.003,     // ç´°ã„ç·šã®å¤ªã•
            playerRadius: baseSize * 0.028, // é¸æ‰‹ã®å¤§ãã•ï¼ˆåŠå¾„ï¼‰
            puckRadius: baseSize * 0.015,   // ãƒ‘ãƒƒã‚¯ã®å¤§ãã•
            fontSize: baseSize * 0.022,     // æ–‡å­—ã‚µã‚¤ã‚º
            benchTop: height * 0.1,         // ä¸Šãƒ™ãƒ³ãƒã®é«˜ã•
            toolbarArea: height * 0.15      // ä¸‹ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚¨ãƒªã‚¢
        };

        const stage = new Konva.Stage({
            container: 'container',
            width: width,
            height: height,
        });

        Konva.hitOnDragEnabled = true;

        const backgroundLayer = new Konva.Layer();
        const drawingLayer = new Konva.Layer();
        const playerLayer = new Konva.Layer(); 
        
        stage.add(backgroundLayer);
        stage.add(drawingLayer);
        stage.add(playerLayer);


        // --- 2. ãƒªãƒ³ã‚¯æç”» (ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ) ---
        
        const padding = 10;
        const rinkWidth = width - (padding * 2);
        const rinkHeight = height - SIZES.benchTop - SIZES.toolbarArea - padding;
        const startX = padding;
        const startY = SIZES.benchTop + padding; 

        // æ°·ã®é¢
        const ice = new Konva.Rect({
            x: startX, y: startY,
            width: rinkWidth, height: rinkHeight,
            fill: 'white',
            stroke: 'black',
            strokeWidth: SIZES.lineThick,
            cornerRadius: rinkHeight * 0.12,
            listening: false 
        });
        backgroundLayer.add(ice);

        const rinkGroup = new Konva.Group({
            clipFunc: function(ctx) {
                ctx.roundRect(startX, startY, rinkWidth, rinkHeight, rinkHeight * 0.12);
            },
            listening: false 
        });
        backgroundLayer.add(rinkGroup);

        // --- ãƒ©ã‚¤ãƒ³é–¢ä¿‚ ---
        // ã‚»ãƒ³ã‚¿ãƒ¼ãƒ©ã‚¤ãƒ³
        rinkGroup.add(new Konva.Line({
            points: [startX + rinkWidth / 2, startY, startX + rinkWidth / 2, startY + rinkHeight],
            stroke: '#C8102E', strokeWidth: SIZES.lineThick
        }));

        // ãƒ–ãƒ«ãƒ¼ãƒ©ã‚¤ãƒ³
        const zoneWidth = rinkWidth / 3;
        rinkGroup.add(new Konva.Line({
            points: [startX + zoneWidth, startY, startX + zoneWidth, startY + rinkHeight],
            stroke: '#0033A0', strokeWidth: SIZES.lineThick
        }));
        rinkGroup.add(new Konva.Line({
            points: [startX + rinkWidth - zoneWidth, startY, startX + rinkWidth - zoneWidth, startY + rinkHeight],
            stroke: '#0033A0', strokeWidth: SIZES.lineThick
        }));

        // ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³
        const goalDist = rinkWidth * 0.05;
        rinkGroup.add(new Konva.Line({
            points: [startX + goalDist, startY, startX + goalDist, startY + rinkHeight],
            stroke: '#C8102E', strokeWidth: SIZES.lineThin
        }));
        rinkGroup.add(new Konva.Line({
            points: [startX + rinkWidth - goalDist, startY, startX + rinkWidth - goalDist, startY + rinkHeight],
            stroke: '#C8102E', strokeWidth: SIZES.lineThin
        }));

        // --- ã‚µãƒ¼ã‚¯ãƒ«é–¢ä¿‚ ---
        // ã‚»ãƒ³ã‚¿ãƒ¼ã‚µãƒ¼ã‚¯ãƒ«
        rinkGroup.add(new Konva.Circle({
            x: startX + rinkWidth / 2,
            y: startY + rinkHeight / 2,
            radius: rinkHeight * 0.15,
            stroke: '#0033A0', strokeWidth: SIZES.lineThin
        }));
        rinkGroup.add(new Konva.Circle({
            x: startX + rinkWidth / 2,
            y: startY + rinkHeight / 2,
            radius: SIZES.lineThin * 1.5, fill: '#0033A0'
        }));

        function drawFaceoffCircle(cx, cy) {
            rinkGroup.add(new Konva.Circle({
                x: cx, y: cy,
                radius: rinkHeight * 0.15,
                stroke: '#C8102E', strokeWidth: SIZES.lineThin
            }));
            rinkGroup.add(new Konva.Circle({
                x: cx, y: cy,
                radius: SIZES.lineThin * 1.5, fill: '#C8102E'
            }));
        }

        const circleX_Left = startX + zoneWidth * 0.55;
        const circleX_Right = startX + rinkWidth - (zoneWidth * 0.55);
        const circleY_Top = startY + rinkHeight * 0.25;
        const circleY_Bottom = startY + rinkHeight * 0.75;

        drawFaceoffCircle(circleX_Left, circleY_Top);
        drawFaceoffCircle(circleX_Left, circleY_Bottom);
        drawFaceoffCircle(circleX_Right, circleY_Top);
        drawFaceoffCircle(circleX_Right, circleY_Bottom);

        // ã‚´ãƒ¼ãƒ«ã‚¯ãƒªãƒ¼ã‚º
        rinkGroup.add(new Konva.Arc({
            x: startX + goalDist,
            y: startY + rinkHeight / 2,
            innerRadius: 0,
            outerRadius: rinkHeight * 0.06,
            angle: 180,
            rotation: -90,
            fill: '#41b6e6', opacity: 0.5
        }));
        rinkGroup.add(new Konva.Arc({
            x: startX + rinkWidth - goalDist,
            y: startY + rinkHeight / 2,
            innerRadius: 0,
            outerRadius: rinkHeight * 0.06,
            angle: 180,
            rotation: 90,
            fill: '#41b6e6', opacity: 0.5
        }));


        // --- 3. é¸æ‰‹ãƒ»ãƒ¬ãƒ•ã‚§ãƒªãƒ¼ (ã‚µã‚¤ã‚ºè‡ªå‹•è¨ˆç®—) ---
        function addPlayer(x, y, color, label) {
            const group = new Konva.Group({
                x: x, y: y,
                draggable: true,
            });

            // å††ã®å¤§ãã•è¨ˆç®—
            const r = SIZES.playerRadius;

            const circle = new Konva.Circle({
                radius: r,
                fill: color,
                stroke: 'white',
                strokeWidth: 2,
                shadowColor: 'black',
                shadowBlur: 3,
                shadowOffset: {x: 1, y: 1},
                shadowOpacity: 0.5
            });

            const text = new Konva.Text({
                text: label,
                fontSize: SIZES.fontSize,
                fill: 'white',
                fontStyle: 'bold',
                align: 'center',
                verticalAlign: 'middle',
                // ä¸­å¿ƒåˆã‚ã›è¨ˆç®—
                offsetX: SIZES.fontSize * 0.7, 
                offsetY: SIZES.fontSize * 0.45,
            });

            group.add(circle);
            group.add(text);
            
            group.on('mouseenter', () => stage.container().style.cursor = 'pointer');
            group.on('mouseleave', () => stage.container().style.cursor = 'default');

            playerLayer.add(group);

            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã‚‚å‹•çš„ã«
            const cacheSize = r * 2 + 10;
            group.cache({
                pixelRatio: 3,
                x: -r - 5, y: -r - 5, width: cacheSize, height: cacheSize
            });
        }

        // --- ãƒ‘ãƒƒã‚¯ (ã‚µã‚¤ã‚ºè‡ªå‹•è¨ˆç®—) ---
        function addPuck(x, y) {
            const group = new Konva.Group({
                x: x, y: y,
                draggable: true,
            });

            const r = SIZES.puckRadius;

            const puck = new Konva.Circle({
                radius: r,
                fill: 'black',
                stroke: '#666',
                strokeWidth: 1,
                shadowColor: 'black',
                shadowBlur: 2,
                shadowOffset: {x: 2, y: 2},
                shadowOpacity: 0.5
            });

            group.add(puck);

            group.on('mouseenter', () => stage.container().style.cursor = 'pointer');
            group.on('mouseleave', () => stage.container().style.cursor = 'default');

            playerLayer.add(group);
            
            const cacheSize = r * 2 + 6;
            group.cache({
                pixelRatio: 3,
                x: -r - 3, y: -r - 3, width: cacheSize, height: cacheSize
            });
        }


        // é…ç½®å®Ÿè¡Œ
        const playerPositions = ['LW', 'CF', 'RW', 'LD', 'RD'];
        const halfWidth = width / 2;
        const playerStep = halfWidth / 6; 
        const playerY = SIZES.benchTop * 0.6; // ãƒ™ãƒ³ãƒã‚¨ãƒªã‚¢ã®ä¸­å¤®

        // èµ¤ãƒãƒ¼ãƒ 
        playerPositions.forEach((pos, index) => {
            const x = playerStep * (index + 0.8); 
            addPlayer(x, playerY, '#d62828', pos);
        });

        // é’ãƒãƒ¼ãƒ 
        playerPositions.forEach((pos, index) => {
            const x = halfWidth + (playerStep * (index + 0.8));
            addPlayer(x, playerY, '#0077b6', pos);
        });

        // ãƒ¬ãƒ•ã‚§ãƒªãƒ¼ & ãƒ‘ãƒƒã‚¯ä½ç½®
        // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®ä¸Šå´ã€ç”»é¢ä¸‹ã‹ã‚‰å°‘ã—æµ®ã‹ã›ãŸä½ç½®
        const refY = height - SIZES.toolbarArea + 20; 

        // å·¦å¯©åˆ¤
        const leftRefs = ['L1', 'L2'];
        leftRefs.forEach((pos, index) => {
            const x = width * (0.08 + (index * 0.08)); 
            addPlayer(x, refY, '#444444', pos);
        });

        // å³å¯©åˆ¤
        const rightRefs = ['R1', 'R2'];
        rightRefs.forEach((pos, index) => {
            const x = width * (0.84 + (index * 0.08));
            addPlayer(x, refY, '#444444', pos);
        });
        
        // ãƒ‘ãƒƒã‚¯é…ç½®
        addPuck(startX + rinkWidth / 2, startY + rinkHeight / 2);
        addPuck(width * 0.5, refY);


        // --- 4. ãƒšãƒ³ã¨æ¶ˆã—ã‚´ãƒ  ---
        let isPaint = false;
        let mode = 'drag'; 
        let lastLine;

        const modes = ['drag', 'pen', 'eraser'];
        modes.forEach(m => {
            document.getElementById(`mode-${m}`).addEventListener('click', () => {
                mode = m;
                updateButtons();
                const isDraggable = (mode === 'drag');
                playerLayer.find('Group').forEach(g => g.draggable(isDraggable));
            });
        });

        function updateButtons() {
            modes.forEach(m => {
                const btn = document.getElementById(`mode-${m}`);
                btn.className = (mode === m) ? 'active' : '';
            });
        }

        stage.on('mousedown touchstart', function (e) {
            if (mode === 'drag') return;
            isPaint = true;
            const pos = stage.getPointerPosition();
            
            // ç·šã®å¤ªã•ã‚‚ç”»é¢ã‚µã‚¤ã‚ºã«é€£å‹•ã•ã›ã‚‹
            const penWidth = mode === 'pen' ? SIZES.lineThick : SIZES.playerRadius * 1.5;
            
            lastLine = new Konva.Line({
                stroke: mode === 'pen' ? 'black' : '#222',
                strokeWidth: penWidth,
                globalCompositeOperation: mode === 'pen' ? 'source-over' : 'destination-out',
                points: [pos.x, pos.y],
                lineCap: 'round',
                lineJoin: 'round',
                tension: 0.5,
                listening: false 
            });
            drawingLayer.add(lastLine);
        });

        stage.on('mouseup touchend', function () {
            isPaint = false;
        });

        stage.on('mousemove touchmove', function (e) {
            if (!isPaint || mode === 'drag') return;
            e.evt.preventDefault();
            const pos = stage.getPointerPosition();
            const newPoints = lastLine.points().concat([pos.x, pos.y]);
            lastLine.points(newPoints);
        });

        document.getElementById('clear-btn').addEventListener('click', function() {
            drawingLayer.destroyChildren();
            drawingLayer.batchDraw();
        });

        // â˜…â˜…â˜… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®è‚ â˜…â˜…â˜…
        // ç”»é¢ã‚µã‚¤ã‚ºãŒå¤‰ã‚ã£ãŸã‚Šã€ã‚¹ãƒãƒ›ã‚’å›è»¢ã•ã›ãŸæ™‚ã«
        // ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç›´ã™å‡¦ç†
        window.addEventListener("resize", function() {
            // æ–‡å­—å…¥åŠ›ä¸­ãªã©ã§ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒå‡ºãŸã ã‘ã®æ™‚ã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ãªã„åˆ¤å®šãªã©ã‚’å…¥ã‚Œã‚‹ã®ãŒæœ¬æ ¼çš„ã§ã™ãŒ
            // ç°¡æ˜“çš„ã«ã€Œæ¨ªå¹…ãŒå¤§ããå¤‰ã‚ã£ãŸã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ã€ã¨ã—ã¾ã™
            if (Math.abs(window.innerWidth - width) > 100) {
                location.reload();
            }
        });

    </script>
</body>
</html>
